type: update
name: Elastic Beats
id: elasticbeats

logo: https://raw.githubusercontent.com/SiryjVyiko/beats-addon/main/elastic-beats.png
description:
  short: 'Elastic Beats: Lightweight data shippers'
  text: |
    Beats is a free and open platform for single-purpose data shippers. They send data from nodes of your environments to Logstash or OpenSearch (Elasticsearch).
homepage: https://www.elastic.co/beats/

targetNodes: any

settings:
  main:
    fields:
      - type: checkboxlist
        caption: Installed agents
        name: options
        columns: 2
        values:
          - name: filebeat
            caption: Filebeat
            value: true

          - name: journalbeat
            caption: Journalbeat
            value: false
          
          - name: packetbeat
            caption: Packetbeat
            value: false

          - name: metricbeat
            caption: Metribeat
            value: false

          - name: heartbeat
            caption: Heartbeat
            value: false
  
      - type: string
        name: opensearchHost
        caption: OpenSearch Host (optional)
        placeholder: 0.0.0.0:9200
        required: false
      
      - type: compositefield
        caption: Credentials (optional)
        defaultMargins: 0 10 0 0
        items:
          - type: string
            name: opensearchUser
            placeholder: User
            width: 200

          - type: displayfield
            cls: x-form-item-label
            value: Password
            width: 60

          - type: string
            name: opensearchPassword
            inputType: password
            width: 163
          
      - type: string
        name: osearchdashboardHost
        caption: OpenSearch Dashboards Host (optional)
        placeholder: 0.0.0.0:5601
        required: false
      
      - type: string
        name: logstashHost
        caption: Logstash Host (optional)
        placeholder: 0.0.0.0:5044
        required: false
      
      - type: list
        name: beatsossversion
        caption: Beats OSS version
        values:
          7.12.1: 7.12.1
          latest: latest
        default: 7.12.1
        hideLabel: false
        hidden: false

nodeGroupAlias:
  ${targetNodes.nodeGroup}: target
  
buttons:
  - caption: Configure
    settings: main
    action: configure

onInstall:
  - if ('${settings.options}' != ''):
    - installBeats: 
        affectedNodes: ${targetNodes.nodeGroup}

onAfterRedeployContainer [target]:
  installBeats:
    affectedNodes: ${event.params.nodeGroup:[event.params.nodeId]}

onAfterScaleOut [target]:
  installBeats: 
    affectedNodes: ${event.response.nodes.join(id,)}
    
onAfterClone:
  - script: delete MANIFEST.id; return {result:0, jps:MANIFEST};
  - install [${targetNodes.nodeGroup}]: ${response.jps}
    envName: ${event.response.env.envName}
    settings:
      options: ${settings.options}
      filebeat: ${settings.filebeat}
      journalbeat: ${settings.journalbeat}
      packetbeat: ${settings.packetbeat}
      metricbeat: ${settings.metricbeat}
      heartbeat: ${settings.heartbeat}
      opensearchHost: ${settings.opensearchHost}
      osearchdashboardHost: ${settings.osearchdashboardHost}
      logstashHost: ${settings.logstashHost}
      beatsossversion: ${settings.beatsossversion}
      opensearchUser: ${settings.opensearchUser}
      opensearchPassword: ${settings.opensearchPassword}

onUninstall:
  uninstallAllAgents
  
actions:
  installBeats:
    - if ('${settings.options}' != ''):
      - addSigninKey
      - createRepo
      - if (${settings.filebeat:true}):
          installAgent:
            agentName: filebeat
            affectedNodes: ${this.affectedNodes}
            serviceConfigPath: /etc/filebeat/filebeat.yml
          installModules:
            agentName: filebeat
            affectedNodes: ${this.affectedNodes}
      - else:
          removeAgent:
            agentName: filebeat
            affectedNodes: ${this.affectedNodes}
      - if (${settings.journalbeat:true}):
          installAgent:
            agentName: journalbeat
            affectedNodes: ${this.affectedNodes}
            serviceConfigPath: /etc/journalbeat/journalbeat.yml
      - else:
          removeAgent:
            agentName: journalbeat
            affectedNodes: ${this.affectedNodes}
      - if (${settings.packetbeat:true}):
          installAgent:
            agentName: packetbeat
            affectedNodes: ${this.affectedNodes}
            serviceConfigPath: /etc/packetbeat/packetbeat.yml
      - else:
          removeAgent:
            agentName: packetbeat
            affectedNodes: ${this.affectedNodes}
      - if (${settings.metricbeat:true}):
          installAgent:
            agentName: metricbeat
            affectedNodes: ${this.affectedNodes}
            serviceConfigPath: /etc/metricbeat/metricbeat.yml
          installModules:
            agentName: metricbeat
            affectedNodes: ${this.affectedNodes}
      - else:
          removeAgent:
            agentName: metricbeat
            affectedNodes: ${this.affectedNodes}
      - if (${settings.heartbeat:true}):
          installAgent:
            agentName: heartbeat-elastic
            affectedNodes: ${this.affectedNodes}
            serviceConfigPath: /etc/heartbeat/heartbeat.yml
      - else:
          removeAgent:
            agentName: heartbeat-elastic
            affectedNodes: ${this.affectedNodes}
    - else:
        uninstallAllAgents
        
  installAgent:
    - installPackage:
        packageName: ${this.agentName}
        affectedNodes: ${this.affectedNodes}
    - configureService:
        serviceConfigPath: ${this.serviceConfigPath}
        affectedNodes: ${this.affectedNodes}
    - fixBeatsPermissions:
        serviceConfigPath: ${this.serviceConfigPath}
        affectedNodes: ${this.affectedNodes}
    - addToExtendPerm:
        agentName: ${this.agentName}
        affectedNodes: ${this.affectedNodes}
    - addServiceToSudoers:
        agentName: ${this.agentName}
        affectedNodes: ${this.affectedNodes}
    - removeStrictPerms:
        agentName: ${this.agentName}
        affectedNodes: ${this.affectedNodes}
       
  removeStrictPerms:
    - if ('${this.agentName}' == 'heartbeat-elastic'):
        - set:
            logFolder: heartbeat
    - if ('${this.agentName}' != 'heartbeat-elastic'):
        - set:
            logFolder: ${this.agentName}
    - cmd [${targetNodes.nodeGroup}]: |-
        sed -ci -e 's|--path.logs /var/log/${this.logFolder}|--path.logs /var/log/${this.logFolder} --strict.perms=false|' /usr/lib/systemd/system/${this.agentName}.service
        systemctl daemon-reload; systemctl start ${this.agentName}
      user: root

  addSigninKey:
    cmd [${targetNodes.nodeGroup}]: |-
      if which yum &>/dev/null; then
          rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch
      else
          wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
      fi
    user: root
  
  addToExtendPerm:
    cmd [${this.affectedNodes}]: |- 
      grep -q ${this.agentName} /etc/jelastic/extendperm.conf || sed -ci -e 's|common |common /etc/${this.agentName};/var/log/${this.agentName};|g' /etc/jelastic/extendperm.conf;
      jem filemanager extendperm;
    user: root
    
  createRepo:
    - set:
        body: |
          [elastic-7.x]
          name=Elastic repository for OSS 7.x packages
          baseurl=https://artifacts.elastic.co/packages/oss-7.x/yum
          gpgcheck=1
          gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
          enabled=1
          autorefresh=1
          type=rpm-md

    - cmd [${targetNodes.nodeGroup}]: |-
        if which yum &>/dev/null; then 
            echo '${this.body}' > /etc/yum.repos.d/elastic.repo
        else
            echo "deb https://artifacts.elastic.co/packages/7.x/apt stable main" > /etc/apt/sources.list.d/elastic-7.x.list
        fi
      user: root
      
  addServiceToSudoers:
    - set:
        body: |
          Cmnd_Alias agent_name_SERVICE = /sbin/service ${this.agentName} *, /usr/bin/systemctl * ${this.agentName}.service, /etc/init.d/${this.agentName} *, /urs/bin/${this.agentName} *, /usr/bin/systemctl * ${this.agentName}
          %ssh-access ALL = NOPASSWD: agent_name_SERVICE
    - cmd [${this.affectedNodes}]: |-
        echo '${this.body}' > /etc/sudoers.d/${this.agentName}
        sed -ci -e "s/agent_name/$(echo ${this.agentName}|awk -F- '{print $1}'|tr a-z A-Z)/" /etc/sudoers.d/${this.agentName}
      user: root
      
  installPackage:
    - if ('${settings.beatsossversion}' == 'latest'):
        - cmd [${this.affectedNodes}]: |-
            if which yum &>/dev/null; then
              if ! rpm -qa|grep ${this.packageName}; then 
                yum install -y ${this.packageName}
              fi
            else
              if ! apt list --installed 2>/dev/null|grep -q ${this.packageName}; then
                apt install -y ${this.packageName}
              fi
            fi
          user: root
    - else:
        - cmd [${this.affectedNodes}]: |-
            if which yum &>/dev/null; then
              if ! rpm -qa|grep ${this.packageName}; then
                yum install -y ${this.packageName}-${settings.beatsossversion}
              fi
            else
              if ! apt list --installed 2>/dev/null|grep -q ${this.packageName}; then
                 curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-${settings.beatsossversion}-amd64.deb && \
                 dpkg -i filebeat-${settings.beatsossversion}-amd64.deb
              fi
            fi
          user: root
    - cmd [${this.affectedNodes}]: |-
        systemctl enable ${this.packageName}
      user: root  
  
  fixBeatsPermissions:
    - cmd[${this.affectedNodes}]: |-
        chmod go-w ${this.serviceConfigPath};
      user: root
      
  configureService:
    - if ('${settings.opensearchHost:}'):
        - cmd [${this.affectedNodes}]: |-
            sed -ci -e 's/^#output.elasticsearch:/output.elasticsearch:/g' ${this.serviceConfigPath};
            grep -q 'ssl.verification_mode' ${this.serviceConfigPath} || sed -ci -e '/^output.elasticsearch/ a\  ssl.verification_mode: "none"' ${this.serviceConfigPath};
            sed -ci -e 's/[#]*hosts:[[:space:]]*\[".*:9200"\]/hosts: ["${settings.opensearchHost}"]/g' ${this.serviceConfigPath};
            sed -ci -e 's/#protocol: "https"/protocol: "https"/g' ${this.serviceConfigPath};
          user: root
        - if ('${settings.opensearchUser:}'):
            - cmd [${this.affectedNodes}]: |-
                sed -ci -e 's/#username:[[:space:]]*"elastic"/username: "${settings.opensearchUser}"/g' ${this.serviceConfigPath};
                sed -ci -e 's/#password:[[:space:]]*"changeme"/password: "${settings.opensearchPassword:}"/g' ${this.serviceConfigPath};
              user: root     
    - else:
        - cmd [${this.affectedNodes}]: |-
            sed -ci -e 's/^[[:space:]]*output.elasticsearch:/#output.elasticsearch:/g' ${this.serviceConfigPath};
            sed -ci -e 's/^[[:space:]]*hosts:[[:space:]]*\[".*:9200"\]/  #hosts: ["localhost:9200"]/g' ${this.serviceConfigPath};
            sed -ci -e 's/[#]*output.logstash:/output.logstash:/g' ${this.serviceConfigPath};
          user: root
        - if ('${settings.logstashHost:}'):
            - cmd [${this.affectedNodes}]: |-
                sed -ci -e 's/[#]*hosts:[[:space:]]*\[".*:5044"\]/hosts: \["${settings.logstashHost}"\]/g' ${this.serviceConfigPath};
              user: root
        - else:
            - cmd [${this.affectedNodes}]: |-
                sed -ci -e 's/[#]*hosts:[[:space:]]*\[".*:5044"\]/hosts: \["localhost:5044"\]/g' ${this.serviceConfigPath};
              user: root
    - if ('${settings.osearchdashboardHost:}'):
        - cmd [${this.affectedNodes}]: |-
            sed -ci -e 's/[#]*host:[[:space:]]*".*:5601"/host: "${settings.osearchdashboardHost}"/g' ${this.serviceConfigPath};
          user: root
    - else:
        - cmd [${this.affectedNodes}]: |-
            sed -ci -e 's/hosts:[[:space:]]*\[".*:5061"\]/#hosts: \["localhost:5061"\]/g' ${this.serviceConfigPath};
          user: root
    - cmd [${this.affectedNodes}]: |-
        if which jem; then jem filemanager extendperm; else true; fi
      user: root
  
  installModules:        
    - script: |
        var fbModules = ['system'];

        var nodeTypeModules = {
          'nginx.*': [ 'nginx' ],
          'haproxy.*': [ 'haproxy' ],
          'apache.*': [ 'apache' ],
          'redis.*': [ 'redis' ],
          'postgres.*': [ 'postgresql' ],
          'mysql.*|mariadb.*|percona.*': [ 'mysql' ],
          'mongo.*': [ 'mongodb' ]
        };

        for (var pattern in nodeTypeModules) {
          if (new RegExp(pattern).test('${targetNodes.nodeType}')) {
            fbModules = fbModules.concat(nodeTypeModules[pattern]);
          }
        }

        return { result: 0, modules: fbModules.join(" ")};

    - cmd [${this.affectedNodes}]: |-
        chmod go-w /etc/${this.agentName}/${this.agentName}.yml
        ${this.agentName} modules enable ${response.modules}
        ${this.agentName} setup
        service ${this.agentName} restart
      user: root
      
  removeAgent:
    - cmd [${this.affectedNodes}]: |-
        rm -f /etc/yum.repos.d/${this.agentName};
        yum -y remove ${this.agentName};
      user: root
  
  configure:
    installBeats: 
      affectedNodes: ${targetNodes.nodeGroup}
      
  uninstallAllAgents:
    cmd [target]: |- 
      yum -y remove filebeat journalbeat auditbeat packetbeat metricbeat heartbeat
      rm -f /etc/yum.repos.d/elastic.repo /etc/sudoers.d/*.beat$
    user: root
